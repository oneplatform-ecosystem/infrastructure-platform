# Azure Application Security Group (ASG) Terraform Module

This Terraform module creates and manages an Azure Application Security Group (ASG).

## Overview

Application Security Groups (ASGs) enable you to group virtual machines and define network security policies based on those groups. ASGs provide a way to logically group NICs for security rule management, making it easier to manage security at scale.

## Features

- Creates an Azure Application Security Group
- Supports custom naming with fallback to label-generated names
- Consistent tagging using CloudPosse label module
- Conditional resource creation with `enabled` flag
- Full support for standard label module variables

## Usage

### Basic Example

```hcl
module "asg" {
  source = "./modules/azure-asg"

  enabled             = true
  name                = "web"
  environment         = "prod"
  stage               = "app"
  location            = "eastus"
  resource_group_name = "my-resource-group"

  tags = {
    Project = "MyProject"
  }
}
```

### With Custom Name

```hcl
module "asg" {
  source = "./modules/azure-asg"

  enabled             = true
  asg_name            = "custom-asg-name"
  location            = "eastus"
  resource_group_name = "my-resource-group"

  tags = {
    Project = "MyProject"
  }
}
```

### Using with Atmos

Add to your stack configuration:

```yaml
import:
  - catalog/azure-asg/defaults
  - catalog/azure-asg/mixins/dev

components:
  terraform:
    azure-asg-web:
      vars:
        name: "web"
        location: "eastus"
        resource_group_name: !terraform.output azure-resource-group ".resource_group_name"
```

## Requirements

| Name | Version |
|------|---------|
| terraform | >= 1.9.0 |
| azurerm | >= 4.0.0 |
| null | 0.25.0 |

## Providers

| Name | Version |
|------|---------|
| azurerm | >= 4.0.0 |

## Resources

| Name | Type |
|------|------|
| [azurerm_application_security_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/application_security_group) | resource |

## Inputs

### Required Inputs

| Name | Description | Type |
|------|-------------|------|
| location | The Azure Region where the Application Security Group should exist | `string` |
| resource_group_name | The name of the Resource Group in which the Application Security Group should exist | `string` |

### Optional Inputs

| Name | Description | Type | Default |
|------|-------------|------|---------|
| enabled | Set to false to prevent the module from creating any resources | `bool` | `true` |
| asg_name | The name of the Application Security Group. If not provided, the name will be generated using the label module | `string` | `null` |
| namespace | Namespace, which could be your organization name or abbreviation | `string` | `null` |
| tenant | ID element for customer identifier | `string` | `null` |
| environment | ID element. Usually used for region e.g. 'uw2', 'us-west-2', OR role 'prod', 'staging', 'dev', 'UAT' | `string` | `null` |
| stage | ID element. Usually used to indicate role, e.g. 'prod', 'staging', 'source', 'build', 'test', 'deploy', 'release' | `string` | `null` |
| name | ID element. Usually the component or solution name | `string` | `null` |
| attributes | ID element. Additional attributes (e.g. `1`) | `list(string)` | `[]` |
| delimiter | Delimiter to be used between ID elements | `string` | `null` |
| tags | Additional tags (e.g. `{'BusinessUnit': 'XYZ'}`) | `map(string)` | `{}` |
| regex_replace_chars | Terraform regular expression (regex) string. Characters matching the regex will be removed from the ID elements | `string` | `null` |
| label_order | The order in which the labels (ID elements) appear in the `id` | `list(string)` | `null` |
| label_key_case | Controls the letter case of the `tags` keys (label names) for tags generated by this module | `string` | `null` |
| label_value_case | Controls the letter case of ID elements (labels) as included in `id`, set as tag values, and output by this module individually | `string` | `null` |
| id_length_limit | Limit `id` to this many characters (minimum 6). Set to `0` for unlimited length | `number` | `null` |

## Outputs

| Name | Description |
|------|-------------|
| id | The ID of the Application Security Group |
| name | The name of the Application Security Group |
| location | The Azure Region where the Application Security Group exists |
| resource_group_name | The name of the Resource Group in which the Application Security Group exists |
| asg_id | The ID of the Application Security Group (alias for id) |

## Common Use Cases

### 1. Web Application Tier

Create an ASG for web application servers:

```hcl
module "asg_web" {
  source = "./modules/azure-asg"

  name                = "web"
  location            = var.location
  resource_group_name = var.resource_group_name
}
```

### 2. Database Tier

Create an ASG for database servers:

```hcl
module "asg_database" {
  source = "./modules/azure-asg"

  name                = "database"
  location            = var.location
  resource_group_name = var.resource_group_name
}
```

### 3. Multi-tier Application

Create ASGs for different application tiers:

```hcl
module "asg_frontend" {
  source = "./modules/azure-asg"

  name                = "frontend"
  location            = var.location
  resource_group_name = var.resource_group_name
}

module "asg_backend" {
  source = "./modules/azure-asg"

  name                = "backend"
  location            = var.location
  resource_group_name = var.resource_group_name
}

module "asg_data" {
  source = "./modules/azure-asg"

  name                = "data"
  location            = var.location
  resource_group_name = var.resource_group_name
}
```

## Integration with Network Security Rules

ASGs can be used in Network Security Group (NSG) rules to allow or deny traffic:

```hcl
resource "azurerm_network_security_rule" "allow_web_to_backend" {
  name                                       = "allow-web-to-backend"
  priority                                   = 100
  direction                                  = "Inbound"
  access                                     = "Allow"
  protocol                                   = "Tcp"
  source_port_range                          = "*"
  destination_port_range                     = "443"
  source_application_security_group_ids      = [module.asg_web.id]
  destination_application_security_group_ids = [module.asg_backend.id]
  resource_group_name                        = var.resource_group_name
  network_security_group_name                = var.nsg_name
}
```

## Notes

- Application Security Groups must be in the same region as the virtual network
- ASGs can be referenced in NSG rules for source and destination
- ASGs help simplify security management by grouping resources logically
- Changes to ASG membership don't require NSG rule updates

## References

- [Azure Application Security Groups Documentation](https://learn.microsoft.com/en-us/azure/virtual-network/application-security-groups)
- [Terraform azurerm_application_security_group Resource](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/application_security_group)
